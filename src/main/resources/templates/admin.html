<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<div th:replace="~{common :: header}"><title>Admin Dashboard</title></div>
<body>
<div class="wrapper">
    <div th:replace="~{common :: navbar}"></div>
    <div class="main p-3">
        <div class="text-center">
            <h1>Admin Dashboard</h1>

            <!-- Add User Button -->
            <button type="button" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addUserModal">
                Add User
            </button>

            <!-- Add User Modal -->
            <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addUserForm" method="POST" action="/admin/add-user">
                                <!-- Username Field -->
                                <div class="mb-3">
                                    <label for="username" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="username" name="username" required th:value="${username}">
                                    <div class="invalid-feedback" th:if="${usernameError}" th:text="${usernameError}"></div>
                                </div>

                                <!-- Password Field -->
                                <div class="mb-3">
                                    <label for="password" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="password" name="password" required minlength="6">
                                    <div class="invalid-feedback" th:if="${passwordError}" th:text="${passwordError}"></div>
                                </div>

                                <!-- Confirm Password Field -->
                                <div class="mb-3">
                                    <label for="confirmPassword" class="form-label">Confirm Password</label>
                                    <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                                    <div class="invalid-feedback" th:if="${passwordConfirmationError}" th:text="${passwordConfirmationError}"></div>
                                </div>

                                <!-- Role Field -->
                                <div class="mb-3">
                                    <label for="roles" class="form-label">Role</label>
                                    <input type="text" class="form-control" id="roles" name="roles" required th:value="${roles}">
                                    <div class="invalid-feedback" th:if="${rolesError}" th:text="${rolesError}"></div>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="submitAddUserForm()">Add User</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit User Modal -->
            <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editUserForm" th:action="@{/admin/updateUser}" method="post">
                                <input type="hidden" id="editUserId" name="userId">
                                <div class="mb-3">
                                    <label for="editUsername" class="form-label">Username</label>
                                    <input type="text" id="editUsername" name="username" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editPassword" class="form-label">Password</label>
                                    <input type="password" id="editPassword" name="password" class="form-control" minlength="6" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editRoles" class="form-label">Roles</label>
                                    <input type="text" id="editRoles" name="roles" class="form-control" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delete User Modal -->
            <div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="deleteUserModalLabel">Delete User</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete the user <strong id="deleteUsername"></strong>?</p>
                        </div>
                        <div class="modal-footer">
                            <form id="deleteUserForm" th:action="@{/admin/deleteUser}" method="post">
                                <input type="hidden" id="deleteUserId" name="userId">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-danger">Delete</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container mt-4">

                <!-- Combined Filter Form with Role and Status -->
                <form method="GET" action="/admin" class="mb-3">
                    <div class="input-group">
                        <select name="roleFilter" class="form-select" aria-label="Filter by role">
                            <option value="">Select Role</option>
                            <option value="Admin" th:selected="${roleFilter == 'Admin'}">Admin</option>
                            <option value="User" th:selected="${roleFilter == 'User'}">User</option>
                        </select>
                        <select name="statusFilter" class="form-select" aria-label="Filter by status">
                            <option value="">Select Status</option>
                            <option value="true" th:selected="${activeFilter == 'true'}">Active</option>
                            <option value="false" th:selected="${activeFilter == 'false'}">Inactive</option>
                        </select>
                        <input type="text" name="search" class="form-control" placeholder="Search by Username or Role" value="">
                        <button type="submit" class="btn btn-primary">Apply Filters</button>
                    </div>
                </form>

                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                        <tr>
                            <th>Profile</th>
                            <th>User ID</th>
                            <th>Username</th>
                            <th>Active</th>
                            <th>Roles</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- Loop through the list of users -->
                        <tr th:each="user : ${users}">
                            <td class="text-center">
                                <i class='bx bxs-user-circle' style="font-size: 30px; color: #555;"></i>
                            </td>
                            <td th:text="${user.userId}"></td>
                            <td th:text="${user.username}"></td>
                            <td>
                                <span th:style="${user.active} ? 'color: green;' : 'color: red;'" style="font-size: 24px; line-height: 0;">‚óè</span>
                            </td>
                            <td th:text="${user.roles}"></td>
                            <td>
                                <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editUserModal" th:data-user-id="${user.userId}" th:data-username="${user.username}" th:data-roles="${user.roles}">
                                    <i class="bx bx-pencil"></i> Edit
                                </button>
                                <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteUserModal" th:data-user-id="${user.userId}" th:data-username="${user.username}">
                                    <i class="bx bx-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script>
    const hamBurger = document.querySelector(".toggle-btn");
    hamBurger.addEventListener("click", function () {
        document.querySelector("#sidebar").classList.toggle("expand");
    });

    // Modal Reset for Adding User
    const addUserModal = document.getElementById('addUserModal');
    addUserModal.addEventListener('hidden.bs.modal', () => {
        document.getElementById('addUserForm').reset();
        clearErrors(); // Reset errors on modal close
    });

    // Clear error messages
    function clearErrors() {
        document.getElementById('usernameError').innerText = "";
        document.getElementById('passwordError').innerText = "";
        document.getElementById('confirmPasswordError').innerText = "";
        document.getElementById('rolesError').innerText = "";
    }

    // Submit the Add User form with validation and AJAX
    function submitAddUserForm() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const roles = document.getElementById('roles').value;

        let hasError = false;
        clearErrors();  // Clear previous error messages

        // Check if username exists (via AJAX)
        fetch(`/admin/check-username?username=${username}`)
            .then(response => response.json())
            .then(data => {
                if (data.exists) {
                    document.getElementById('usernameError').innerText = "Username already exists.";
                    hasError = true;
                }

                // Check password validity
                if (password.length < 6) {
                    document.getElementById('passwordError').innerText = "Password must be at least 6 characters.";
                    hasError = true;
                }

                // Check if passwords match
                if (password !== confirmPassword) {
                    document.getElementById('confirmPasswordError').innerText = "Passwords do not match.";
                    hasError = true;
                }

                // Check if roles is filled
                if (!roles) {
                    document.getElementById('rolesError').innerText = "Role is required.";
                    hasError = true;
                }

                if (hasError) return;  // Stop if there are validation errors

                // Submit the form using Fetch API after validation
                const formData = new FormData();
                formData.append('username', username);
                formData.append('password', password);
                formData.append('confirmPassword', confirmPassword);
                formData.append('roles', roles);

                fetch('/admin/add-user', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.text())
                .then(result => {
                    alert(result);  // Optionally show a success message
                    window.location.reload();  // Reload the page to reflect new user
                })
                .catch(error => {
                    alert("Error adding user: " + error.message);  // Handle any errors
                });
            })
            .catch(error => {
                alert("Error checking username: " + error.message);
            });
    }
</script>
</body>
</html>
